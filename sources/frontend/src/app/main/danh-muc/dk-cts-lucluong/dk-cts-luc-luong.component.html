<div class="d-flex justify-content-between align-items-center mb-3">
  <page-header title="::Cts.DanhMucs" description="::Cts.DanhMucs.DKCtsLucLuong"></page-header>

  <div class="d-flex align-items-center" style="gap: 8px">
    <button
      class="btn"
      (click)="openExportDialog()"
      style="
        background-color: #005f99;
        border-color: #005f99;
        color: white;
        border-radius: 4px;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 4px;
        height: 24px;
        margin-right: 12px;
      "
    >
      <i class="pi pi-download" style="font-size: 12px"></i>
      Xuất Excel
    </button>
    <button
      class="btn"
      (click)="openImportDialog()"
      style="
        background-color: #f0ad4e;
        border-color: #f0ad4e;
        color: white;
        border-radius: 4px;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 4px;
        height: 24px;
      "
    >
      <i class="pi pi-upload" style="font-size: 12px"></i>
      Nhập Excel
    </button>
    <button
      class="btn"
      (click)="create()"
      style="
        background-color: #22c55e;
        border-color: #22c55e;
        color: white;
        border-radius: 4px;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 4px;
        height: 24px;
        margin-right: 12px;
      "
    >
      <i class="pi pi-plus" style="font-size: 12px"></i>
      Thêm mới
    </button>
  </div>
</div>

<div class="container-fluid">
  <div class="card">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center" style="gap: 8px; padding: 5px 16px 5px 16px">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <p-autoComplete
            #autoCompleteInput
            [(ngModel)]="searchValue"
            [suggestions]="searchSuggestions"
            (completeMethod)="onSearch($event)"
            (onSelect)="onSelect($event)"
            (onClear)="clearSearch()"
            [forceSelection]="false"
            [showClear]="true"
            placeholder="Tìm kiếm"
            field="tenDieuKien"
            [minLength]="0"
            style="height: 38px; width: 100%"
          >
          </p-autoComplete>
        </span>
        <button class="btn btn-custom-filter" (click)="toggleFilter()">
          <i class="pi pi-filter btn-icon"></i>
        </button>
      </div>
    </div>

    <div *ngIf="showFilter" class="filter-section">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Tên điều kiện</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="filterName"
            placeholder="Nhập tên điều kiện"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Mã điều kiện</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="filterMa"
            placeholder="Nhập mã điều kiện"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Trạng thái</label>
          <select class="form-select" [(ngModel)]="filterStatus">
            <option value="">Tất cả</option>
            <option *ngFor="let opt of trangThaiOptions" [value]="opt.value">
              {{ opt.key }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <div class="card-body">
      <table class="table table-sm table-hover">
        <thead>
          <tr class="table-header-row">
            <th class="table-header" style="padding-left: 12px">#</th>
            <th class="table-header">Mã điều kiện</th>
            <th class="table-header">Tên điều kiện</th>
            <th class="table-header">Lực lượng</th>
            <th class="table-header">Trạng thái</th>
            <th class="table-header">Ghi chú</th>
            <th class="table-header" style="width: 120px; text-align: right; padding-right: 12px">
              Hành động
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of dkCtsLucLuong.items; let i = index" class="table-row">
            <td class="table-body" style="padding-left: 12px">{{ i + 1 }}</td>
            <td class="table-body">{{ item.maDieuKien }}</td>
            <td class="table-body">{{ item.tenDieuKien }}</td>
            <td class="table-body">{{ getLucLuongNameById(item.lucLuongId) }}</td>
            <td class="table-body">
              <span
                class="badge"
                [ngClass]="{
                  'bg-success': getTrangThaiSeverity(item.trangThai) === 'success',
                  'bg-danger': getTrangThaiSeverity(item.trangThai) === 'danger',
                  'bg-info': getTrangThaiSeverity(item.trangThai) === 'info'
                }"
                >{{ getTrangThai(item.trangThai) }}</span
              >
            </td>
            <td class="table-body">{{ item.ghiChu }}</td>
            <td class="text-end" style="padding-right: 12px">
              <div ngbDropdown class="d-inline-block">
                <button
                  class="btn"
                  style="
                    background-color: #009ef7;
                    border-color: #009ef7;
                    color: white;
                    border-radius: 4px;
                    padding: 4px 8px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    height: 24px;
                    width: 58px;
                  "
                  ngbDropdownToggle
                >
                  <i class="pi pi-cog" style="font-size: 12px"></i>
                </button>
                <div ngbDropdownMenu>
                  <button ngbDropdownItem (click)="edit(item.id)">Sửa</button>
                  <button ngbDropdownItem class="text-danger" (click)="delete(item.id)">Xóa</button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="d-flex justify-content-end align-items-center">
        <span>
          <span class="pagination-text">Tổng cộng: {{ dkCtsLucLuong.totalCount }}</span>
        </span>
        <p-paginator
          [rows]="pageSize"
          [first]="pageIndex * pageSize"
          [totalRecords]="dkCtsLucLuong?.totalCount || 0"
          [rowsPerPageOptions]="[5, 10, 20, 50]"
          (onPageChange)="onPageChange($event)"
          styleClass="ml-2 custom-paginator pagination-text"
        >
        </p-paginator>
      </div>
    </div>
  </div>

  <p-dialog
    [(visible)]="isModalOpen"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '480px' }"
    [baseZIndex]="1055"
    [dismissableMask]="true"
  >
    <ng-template pTemplate="header">
      <span *ngIf="!selected?.id" class="fw-bold">Thêm điều kiện</span>
      <span *ngIf="selected?.id" class="fw-bold">Sửa điều kiện</span>
    </ng-template>
    <ng-template pTemplate="content">
      <form [formGroup]="form" (ngSubmit)="save()">
        <div class="mb-3">
          <label class="form-label">Mã điều kiện<span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="maDieuKien" />
          <div
            class="text-danger mt-1"
            *ngIf="form?.get('maDieuKien')?.dirty && form?.get('maDieuKien')?.errors?.['maDieuKienDuplicated']"
          >
            Mã điều kiện đã tồn tại
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Tên điều kiện<span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="tenDieuKien" />
        </div>
        <div class="mb-3">
          <label class="form-label">Lực lượng <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="lucLuongId">
            <option [ngValue]="null">-- Chọn lực lượng --</option>
            <option *ngFor="let opt of lucLuongOptions" [ngValue]="opt.id">
              {{ opt.tenLucLuong }}
            </option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="trangThai">
            <option *ngFor="let opt of trangThaiOptions" [ngValue]="opt.value">
              {{ opt.key }}
            </option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Ghi chú</label>
          <textarea class="form-control" formControlName="ghiChu"></textarea>
        </div>
      </form>
    </ng-template>
    <ng-template pTemplate="footer">
      <button type="button" class="btn btn-outline-secondary" (click)="isModalOpen = false">
        Đóng
      </button>
      <button type="submit" class="btn btn-primary" (click)="save()" [disabled]="form?.invalid">
        Lưu
      </button>
    </ng-template>
  </p-dialog>

  <app-export-excel-dialog
    [(visible)]="exportVisible"
    [data]="exportData"
    [columns]="exportColumns"
    [defaultFileName]="'DK_Cts_LucLuong.xlsx'"
    [defaultSheetName]="'DK_Cts_LucLuong'"
    (exported)="onExported()"
  ></app-export-excel-dialog>

  <app-import-excel-dialog
    [(visible)]="showImport"
    [columns]="importColumns"
    [templateFileName]="'import_dk_cts_luc_luong.xlsx'"
    [templateSheetName]="'Sheet1'"
    [requiredFields]="['maDieuKien', 'tenDieuKien']"
    [uniqueByField]="'maDieuKien'"
    [existingValues]="existingMaDieuKienValues"
    (imported)="onImported($event)"
  ></app-import-excel-dialog>
</div>
