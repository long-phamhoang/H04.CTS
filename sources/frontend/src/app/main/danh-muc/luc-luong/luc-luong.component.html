<page-header title="::Cts.DanhMucs" description="::Cts.DanhMucs.LucLuong"></page-header>
<div class="container-fluid">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center" style="gap: 8px">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <p-autoComplete
            #autoCompleteInput
            [(ngModel)]="searchValue"
            [suggestions]="searchSuggestions"
            (completeMethod)="onSearch($event)"
            (onSelect)="onSelect($event)"
            (onClear)="clearSearch()"
            [forceSelection]="false"
            [showClear]="true"
            placeholder="Tìm kiếm"
            field="tenLucLuong"
            [minLength]="0"
            style="height: 38px; width: 100%"
          >
          </p-autoComplete>
        </span>
      </div>
      <div class="d-flex align-items-center" style="gap: 8px">
        <button class="btn btn-success" (click)="openExportDialog()">Xuất Excel</button>
        <button class="btn btn-info" (click)="openImportDialog()">Nhập Excel</button>
        <button class="btn btn-primary" (click)="create()">Thêm mới</button>
      </div>
    </div>
    <div class="card-body">
      <table class="table table-sm table-hover">
        <thead>
          <tr>
            <th>STT</th>
            <th>Mã</th>
            <th>Tên lực lượng</th>
            <th>Trạng thái</th>
            <th>Ghi chú</th>
            <th style="width: 120px; text-align: right">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of displayItems; let i = index">
            <td>{{ pageIndex * pageSize + i + 1 }}</td>
            <td>{{ item.maLucLuong }}</td>
            <td>{{ item.tenLucLuong }}</td>
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'bg-success': getTrangThaiSeverity(item.trangThai) === 'success',
                  'bg-danger': getTrangThaiSeverity(item.trangThai) === 'danger',
                  'bg-info': getTrangThaiSeverity(item.trangThai) === 'info'
                }"
                >{{ getTrangThai(item.trangThai) }}</span
              >
            </td>
            <td>{{ item.ghiChu }}</td>
            <td class="text-end">
              <div ngbDropdown class="d-inline-block">
                <button
                  class="btn btn-primary btn-sm"
                  style="background-color: #009ef7"
                  ngbDropdownToggle
                >
                  <i class="pi pi-cog" style="margin-right: 20px"></i>
                </button>
                <div ngbDropdownMenu>
                  <button ngbDropdownItem (click)="edit(item.id)">Sửa</button>
                  <button ngbDropdownItem class="text-danger" (click)="delete(item.id)">Xóa</button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="d-flex justify-content-end align-items-center">
        <span>
          <span class="total-text" style="opacity: 0.7">Tổng cộng: {{ lucLuong.totalCount }}</span>
        </span>
        <p-paginator
          [rows]="pageSize"
          [first]="pageIndex * pageSize"
          [totalRecords]="lucLuong?.totalCount || 0"
          [rowsPerPageOptions]="[5, 10, 20, 50]"
          (onPageChange)="onPageChange($event)"
          styleClass="ml-2 custom-paginator"
        >
        </p-paginator>
      </div>
    </div>
  </div>

  <p-dialog
    [(visible)]="isModalOpen"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '480px' }"
    [baseZIndex]="1055"
    [dismissableMask]="true"
  >
    <ng-template pTemplate="header">
      <span *ngIf="!selectedLucLuong?.id" class="fw-bold">Thêm lực lượng</span>
      <span *ngIf="selectedLucLuong?.id" class="fw-bold">Sửa lực lượng</span>
    </ng-template>
    <ng-template pTemplate="content">
      <form [formGroup]="form" (ngSubmit)="save()">
        <div class="mb-3">
          <label class="form-label">Mã lực lượng<span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="maLucLuong" />
          <div
            class="text-danger mt-1"
            *ngIf="form?.get('maLucLuong')?.dirty && form?.get('maLucLuong')?.errors?.['maLucLuongDuplicated']"
          >
            Mã lực lượng đã tồn tại
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Tên lực lượng<span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="tenLucLuong" />
        </div>
        <div class="mb-3">
          <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="trangThai">
            <option *ngFor="let opt of trangThaiOptions" [ngValue]="opt.value">
              {{ opt.key }}
            </option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Ghi chú</label>
          <textarea class="form-control" formControlName="ghiChu"></textarea>
        </div>
      </form>
    </ng-template>
    <ng-template pTemplate="footer">
      <button type="button" class="btn btn-outline-secondary" (click)="isModalOpen = false">
        Đóng
      </button>
      <button type="submit" class="btn btn-primary" (click)="save()" [disabled]="form?.invalid">
        Lưu
      </button>
    </ng-template>
  </p-dialog>

  <app-export-excel-dialog
    [(visible)]="exportVisible"
    [data]="exportData"
    [columns]="exportColumns"
    [defaultFileName]="'LucLuong.xlsx'"
    [defaultSheetName]="'LucLuong'"
    (exported)="onExported()"
  ></app-export-excel-dialog>

  <app-import-excel-dialog
    [(visible)]="showImport"
    [columns]="importColumns"
    [templateFileName]="'import_luc_luong.xlsx'"
    [templateSheetName]="'Sheet1'"
    [requiredFields]="['maLucLuong', 'tenLucLuong']"
    [uniqueByField]="'maLucLuong'"
    [existingValues]="existingMaLucLuongValues"
    (imported)="onImported($event)"
  ></app-import-excel-dialog>
</div>
