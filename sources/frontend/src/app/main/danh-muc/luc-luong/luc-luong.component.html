<div class="d-flex justify-content-between align-items-center mb-3">
  <page-header
    [title]="'::DanhMucs' | abpLocalization"
    [description]="'::DanhMucs.LucLuong' | abpLocalization"
  ></page-header>

  <div class="d-flex align-items-center" style="gap: 8px">
    <button
      *ngIf="selectedItems?.length > 0"
      pButton
      type="button"
      icon="pi pi-trash"
      label="Xóa đã chọn"
      (click)="deleteSelected()"
      class="p-button-sm p-button-danger"
    ></button>

    <p-menu #menu [popup]="true" [model]="functionMenuItems"></p-menu>
    <button
      pButton
      type="button"
      (click)="menu.toggle($event)"
      class="p-button-sm"
      style="height: 30px; display: flex; align-items: center; gap: 8px; padding: 0 12px"
    >
      <i class="pi pi-file-excel"></i>
      <span>Xuất dữ liệu</span>
      <i class="pi pi-arrow-down" style="font-size: 10px"></i>
    </button>

    <button
      pButton
      type="button"
      icon="pi pi-plus"
      label="Thêm mới"
      (click)="create()"
      class="p-button-sm p-button-success"
      style="margin-right: 12px"
    ></button>
  </div>
</div>

<div class="container-fluid">
  <div class="card">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center" style="gap: 8px; padding: 13px 16px 7px 16px">
        <p-inputgroup style="width: 400px">
          <p-inputgroup-addon>
            <i class="pi pi-search"></i>
          </p-inputgroup-addon>
          <input
            pInputText
            [(ngModel)]="searchValue"
            placeholder="Tìm kiếm"
            (input)="onSearchInput($event)"
            style="height: 35px"
            #searchInput
          />
        </p-inputgroup>
        <button
          pButton
          type="button"
          icon="pi pi-filter"
          (click)="toggleFilter()"
          class="p-button-sm p-button-outlined"
        ></button>
      </div>
    </div>

    <div *ngIf="showFilter" class="filter-section">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Tên lực lượng</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="filterName"
            (ngModelChange)="applyFilter()"
            placeholder="Nhập tên lực lượng"
            class="w-100"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Mã lực lượng</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="filterCode"
            (ngModelChange)="applyFilter()"
            placeholder="Nhập mã lực lượng"
            class="w-100"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Trạng thái</label>
          <p-dropdown
            [options]="trangThaiOptions"
            optionLabel="key"
            optionValue="value"
            [(ngModel)]="filterStatus"
            (onChange)="applyFilter()"
            [showClear]="true"
            placeholder="Tất cả"
            class="w-100"
          ></p-dropdown>
        </div>
      </div>
    </div>

    <div class="card-body">
      <p-table
        [value]="displayItems"
        dataKey="id"
        [(selection)]="selectedItems"
        showGridlines
        styleClass="p-datatable-sm p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="padding-left: 12px; width: 3rem" class="table-header">
              <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
            </th>
            <th style="width: 3%" class="table-header">#</th>
            <th style="width: 20%" class="table-header">Mã</th>
            <th style="width: 25%" class="table-header">Tên lực lượng</th>
            <th style="width: 11%" class="table-header">Trạng thái</th>
            <th class="table-header">Ghi chú</th>
            <th class="table-header" style="width: 100px; text-align: right; padding-right: 12px">
              Hành động
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
          <tr>
            <td style="padding-left: 12px">
              <p-tableCheckbox [value]="item"></p-tableCheckbox>
            </td>
            <td>{{ pageIndex * pageSize + rowIndex + 1 }}</td>
            <td>{{ item.maLucLuong }}</td>
            <td>{{ item.tenLucLuong }}</td>
            <td>
              <p-tag
                [value]="getTrangThai(item.trangThai)"
                [severity]="getTrangThaiSeverity(item.trangThai)"
              ></p-tag>
            </td>
            <td
              style="
                word-wrap: break-word;
                word-break: break-word;
                max-width: 200px;
                white-space: normal;
              "
              [pTooltip]="item.ghiChu?.length > 128 ? item.ghiChu : null"
              tooltipPosition="top"
              [showDelay]="500"
              [hideDelay]="0"
            >
              {{
                item.ghiChu?.length > 128 ? (item.ghiChu | slice : 0 : 128) + '...' : item.ghiChu
              }}
            </td>
            <td class="text-end" style="padding-right: 12px">
              <div ngbDropdown class="d-inline-block">
                <button
                  class="btn"
                  style="
                    background-color: #009ef7;
                    border-color: #009ef7;
                    color: white;
                    border-radius: 4px;
                    padding: 4px 8px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    height: 24px;
                    width: 58px;
                  "
                  ngbDropdownToggle
                >
                  <i class="pi pi-cog" style="font-size: 12px"></i>
                </button>
                <div ngbDropdownMenu>
                  <button ngbDropdownItem (click)="edit(item.id)">Sửa</button>
                  <button ngbDropdownItem class="text-danger" (click)="delete(item.id)">Xóa</button>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="d-flex justify-content-end align-items-center">
        <span>
          <span class="pagination-text">Tổng cộng: {{ lucLuong.totalCount }}</span>
        </span>
        <p-paginator
          [rows]="pageSize"
          [first]="pageIndex * pageSize"
          [totalRecords]="lucLuong?.totalCount || 0"
          [rowsPerPageOptions]="[5, 10, 20, 50]"
          (onPageChange)="onPageChange($event)"
          styleClass="ml-2 custom-paginator pagination-text"
        >
        </p-paginator>
      </div>
    </div>
  </div>

  <p-dialog
    [(visible)]="isModalOpen"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '480px' }"
    [baseZIndex]="1055"
    [dismissableMask]="true"
  >
    <ng-template pTemplate="header">
      <span *ngIf="!selectedLucLuong?.id" class="fw-bold">Thêm lực lượng</span>
      <span *ngIf="selectedLucLuong?.id" class="fw-bold">Sửa lực lượng</span>
    </ng-template>
    <ng-template pTemplate="content">
      <form [formGroup]="form" (ngSubmit)="onFormSubmit()">
        <div class="mb-3">
          <label class="form-label">Mã lực lượng<span class="text-danger">*</span></label>
          <input type="text" pInputText formControlName="maLucLuong" class="w-100" />
          <div
            class="text-danger mt-1"
            *ngIf="form?.get('maLucLuong')?.dirty && form?.get('maLucLuong')?.errors?.['maLucLuongDuplicated']"
          >
            Mã lực lượng đã tồn tại
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Tên lực lượng<span class="text-danger">*</span></label>
          <input type="text" pInputText formControlName="tenLucLuong" class="w-100" />
        </div>
        <div class="mb-3">
          <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
          <p-dropdown
            [options]="trangThaiOptions"
            optionLabel="key"
            optionValue="value"
            formControlName="trangThai"
            placeholder="Chọn trạng thái"
            [showClear]="true"
            class="w-100"
          ></p-dropdown>
        </div>
        <div class="mb-3">
          <label class="form-label">Ghi chú</label>
          <textarea
            pInputTextarea
            formControlName="ghiChu"
            [autoResize]="true"
            class="w-100"
          ></textarea>
        </div>
      </form>
    </ng-template>
    <ng-template pTemplate="footer">
      <button
        type="button"
        pButton
        label="Lưu"
        (click)="save()"
        [disabled]="form?.invalid || !formChanged"
      ></button>

      <button
        *ngIf="!selectedLucLuong?.id"
        type="submit"
        pButton
        label="Lưu và tiếp tục"
        (click)="saveAndContinue()"
        [disabled]="form?.invalid || !formChanged"
        class="p-button-success"
      ></button>
      <button
        type="button"
        pButton
        label="Đóng"
        class="p-button-outlined"
        (click)="isModalOpen = false"
      ></button>
    </ng-template>
  </p-dialog>

  <app-export-excel-dialog
    [(visible)]="exportVisible"
    [data]="exportData"
    [columns]="exportColumns"
    [defaultFileName]="'LucLuong.xlsx'"
    [defaultSheetName]="'LucLuong'"
    (exported)="onExported()"
  ></app-export-excel-dialog>

  <app-import-excel-dialog
    [(visible)]="showImport"
    [columns]="importColumns"
    [templateFileName]="'import_luc_luong.xlsx'"
    [templateSheetName]="'Sheet1'"
    [requiredFields]="['maLucLuong', 'tenLucLuong']"
    [uniqueByField]="'maLucLuong'"
    [existingValues]="existingMaLucLuongValues"
    (imported)="onImported($event)"
  ></app-import-excel-dialog>

  <p-confirmDialog
    acceptLabel="Đồng ý"
    rejectLabel="Hủy"
    acceptIcon="pi pi-check"
    rejectIcon="pi pi-times"
  >
  </p-confirmDialog>
</div>
