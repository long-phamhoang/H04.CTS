<page-header [title]="'::DanhMucs' | abpLocalization" [description]="'::DanhMucs.NguoiTiepNhan' | abpLocalization">
</page-header>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">{{ '::Menu:NguoiTiepNhan' | abpLocalization }}</h5>
    <button id="create" class="btn btn-primary" (click)="createNguoiTiepNhan()"
      title="{{ '::CreateNew' | abpLocalization }}">
      <i class="fa fa-plus me-1"></i> {{ '::CreateNew' | abpLocalization }}
    </button>
  </div>

  <div class="card-body custom-border m-3">
    <div class="input-group mb-3" style="width: 300px;">
      <input type="text" class="form-control" placeholder="Tìm kiếm..." [(ngModel)]="keyword"
        (keydown.enter)="onSearch()" />
      <button class="btn btn-outline-secondary" type="button" (click)="onSearch()">
        <i class="fa fa-search"></i>
      </button>
    </div>
    <p-table [value]="nguoiTiepNhan.items" [rows]="pageSize" [lazy]="true" (onLazyLoad)="loadNguoiTiepNhan($event)"
      [loading]="false" class="p-datatable-sm p-datatable-striped p-datatable-gridlines custom-header-table">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 50px;">#</th>
          <th pSortableColumn="FullName">
            {{ '::TenNguoiTiepNhan' | abpLocalization }}
            <p-sortIcon field="FullName"></p-sortIcon>
          </th>
          <th pSortableColumn="CCCD">
            {{ '::CCCD' | abpLocalization }}
            <p-sortIcon field="CCCD"></p-sortIcon>
          </th>
          <th pSortableColumn="Position">
            {{ '::Position' | abpLocalization }}
            <p-sortIcon field="Position"></p-sortIcon>
          </th>
          <th pSortableColumn="Phone">
            {{ '::Phone' | abpLocalization }}
            <p-sortIcon field="Phone"></p-sortIcon>
          </th>
          <th pSortableColumn="Email">
            {{ '::Email' | abpLocalization }}
            <p-sortIcon field="Email"></p-sortIcon>
          </th>
          <th pSortableColumn="SubmissionAddress">
            {{ '::SubmissionAddress' | abpLocalization }}
            <p-sortIcon field="SubmissionAddress"></p-sortIcon>
          </th>
          <th class="col-large-only" pSortableColumn="OrganizationName">
            {{ '::TenCoQuan' | abpLocalization }}
            <p-sortIcon field="OrganizationName"></p-sortIcon>
          </th>
          <th class="col-large-only" pSortableColumn="DateOfIssue">
            {{ '::NgayCapCCCD' | abpLocalization }}
            <p-sortIcon field="DateOfIssue"></p-sortIcon>
          </th>
          <th class="col-large-only" pSortableColumn="NoiCapCCCDName">
            {{ '::NoiCapCCCDName' | abpLocalization }}
            <p-sortIcon field="NoiCapCCCDName"></p-sortIcon>
          </th>
          <th class="col-large-only" pSortableColumn="Province">
            {{ '::Province' | abpLocalization }}
            <p-sortIcon field="Province"></p-sortIcon>
          </th>
          <th class="col-large-only" pSortableColumn="Ward">
            {{ '::Ward' | abpLocalization }}
            <p-sortIcon field="Ward"></p-sortIcon>
          </th>
          <th pSortableColumn="IsDefault">
            {{ '::IsDefault' | abpLocalization }}
            <p-sortIcon field="IsDefault"></p-sortIcon>
          </th>
          <th style="width: 150px;">{{ '::Actions' | abpLocalization }}</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ row.fullName }}</td>
          <td>{{ row.cccd }}</td>
          <td>{{ row.position }}</td>
          <td>{{ row.phone }}</td>
          <td>{{ row.email }}</td>
          <td>{{ row.submissionAddress }}</td>
          <td class="col-large-only">{{ row.organizationName }}</td>
          <td class="col-large-only">{{ row.dateOfIssue }}</td>
          <td class="col-large-only">{{ row.noiCapCCCDName }}</td>
          <td class="col-large-only">{{ row.province }}</td>
          <td class="col-large-only">{{ row.ward }}</td>
          <td>
            <p-toggleSwitch 
              [ngModel]="row.isDefault"
              (onChange)="toggleIsDefault(row, $event.checked)"
            >
            </p-toggleSwitch>
          </td>
          <td>
            <div ngbDropdown container="body" class="d-inline-block">
              <button class="btn btn-primary btn-sm dropdown-toggle" ngbDropdownToggle>
                <i class="fa fa-cog me-1"></i>
              </button>
              <div ngbDropdownMenu>
                <button ngbDropdownItem (click)="editNguoiTiepNhan(row.id)">
                  {{ '::Edit' | abpLocalization }}
                </button>
                <button ngbDropdownItem (click)="delete(row.id)">
                  {{ '::Delete' | abpLocalization }}
                </button>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="14" class="text-center py-3">{{ '::NoDataFound' | abpLocalization }}</td>
        </tr>
      </ng-template>
    </p-table>
    <div class="d-flex justify-content-between align-items-center p-2">
      <div>Tổng cộng: {{ nguoiTiepNhan.totalCount || 0 }}</div>
      <p-paginator [rows]="pageSize" [first]="0" [totalRecords]="nguoiTiepNhan.totalCount || 0"
        [rowsPerPageOptions]="[5, 10, 20, 50]" (onPageChange)="loadNguoiTiepNhan($event)">
      </p-paginator>
    </div>
  </div>
</div>

<!-- Modal -->
<p-dialog 
  [(visible)]="isModalOpen" 
  [modal]="true" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{width: '70vw'}"
  [header]="selectedNguoiTiepNhan?.id ? ('::Edit' | abpLocalization) : ('::NewNguoiTiepNhan' | abpLocalization)"
  [closable]="true">
  
  <div class="modal-body">
    <form [formGroup]="form" (ngSubmit)="save()" class="needs-validation" novalidate>
      <div class="row g-3">
        <div class="col-12">
          <div class="mb-2 fw-bold">Thông tin cơ quan nộp hồ sơ</div>
          <div class="d-flex flex-wrap gap-2">
            <span *ngFor="let org of organizations" class="btn btn-outline-primary btn-sm" [class.active]="form?.value?.organizationId === org.id" (click)="form?.patchValue({ organizationId: org.id })">{{ org.tenToChuc }}</span>
          </div>
        </div>

        <div class="col-12">
          <label for="nguoiTiepNhan-fullName" class="form-label">Họ tên <span class="text-danger">*</span></label>
          <input type="text" id="nguoiTiepNhan-fullName" class="form-control" formControlName="fullName" maxlength="100" placeholder="Họ tên" [class.is-invalid]="form?.controls?.fullName?.invalid && form?.controls?.fullName?.touched" />
        </div>

        <div class="col-12 d-flex align-items-center">
          <label class="form-label me-3">Là mặc định:</label>
          <p-toggleSwitch formControlName="isDefault">
          </p-toggleSwitch>
        </div>

        <div class="col-md-4">
          <label for="nguoiTiepNhan-cccd" class="form-label">Số định danh cá nhân <span class="text-danger">*</span></label>
          <input type="text" id="nguoiTiepNhan-cccd" class="form-control" formControlName="cccd" maxlength="20" placeholder="Số định danh cá nhân" [class.is-invalid]="form?.controls?.cccd?.invalid && form?.controls?.cccd?.touched" />
        </div>
        <div class="col-md-4">
          <label for="nguoiTiepNhan-dateOfIssue" class="form-label">Ngày cấp <span class="text-danger">*</span></label>
            <input type="date" id="nguoiTiepNhan-dateOfIssue" class="form-control" formControlName="dateOfIssue" required
            [class.is-invalid]="form?.controls?.dateOfIssue?.invalid && form?.controls?.dateOfIssue?.touched" />
          <div class="invalid-feedback">{{ '::ValidationRequired' | abpLocalization }}</div>
        </div>
        <div class="col-md-4">
          <label for="nguoiTiepNhan-noiCapCCCDId" class="form-label">Nơi cấp <span class="text-danger">*</span></label>
          <select id="nguoiTiepNhan-noiCapCCCDId" class="form-select" formControlName="noiCapCCCDId">
            <option [ngValue]="null">-- Chọn nơi cấp --</option>
            <option *ngFor="let item of noiCapCCCDs" [ngValue]="item.id">{{ item.name }}</option>
          </select>
        </div>

        <div class="col-md-4">
          <label for="nguoiTiepNhan-position" class="form-label">Chức vụ</label>
          <input type="text" id="nguoiTiepNhan-position" class="form-control" formControlName="position" maxlength="100" placeholder="Chức vụ" />
        </div>
        <div class="col-md-4">
          <label for="nguoiTiepNhan-phone" class="form-label">Điện thoại <span class="text-danger">*</span></label>
          <input type="text" id="nguoiTiepNhan-phone" class="form-control" formControlName="phone" maxlength="20" placeholder="Điện thoại" [class.is-invalid]="form?.controls?.phone?.invalid && form?.controls?.phone?.touched" />
        </div>
        <div class="col-md-4">
          <label for="nguoiTiepNhan-email" class="form-label">Địa chỉ thư điện tử công vụ</label>
          <input type="email" id="nguoiTiepNhan-email" class="form-control" formControlName="email" maxlength="100" placeholder="Email công vụ" />
        </div>

        <div class="col-md-4">
          <label for="nguoiTiepNhan-province" class="form-label">Tỉnh, thành phố <span class="text-danger">*</span></label>
          <input type="text" id="nguoiTiepNhan-province" class="form-control" formControlName="province" maxlength="100" placeholder="Tỉnh, thành phố" [class.is-invalid]="form?.controls?.province?.invalid && form?.controls?.province?.touched" />
        </div>
        <div class="col-md-4">
          <label for="nguoiTiepNhan-ward" class="form-label">Phường, xã <span class="text-danger">*</span></label>
          <input type="text" id="nguoiTiepNhan-ward" class="form-control" formControlName="ward" maxlength="100" placeholder="Phường, xã" [class.is-invalid]="form?.controls?.ward?.invalid && form?.controls?.ward?.touched" />
        </div>

        <div class="col-md-4">
          <label for="nguoiTiepNhan-submissionAddress" class="form-label">Địa chỉ tiếp nhận <span class="text-danger">*</span></label>
          <input type="text" id="nguoiTiepNhan-submissionAddress" class="form-control" formControlName="submissionAddress" maxlength="200" placeholder="Địa chỉ tiếp nhận" [class.is-invalid]="form?.controls?.submissionAddress?.invalid && form?.controls?.submissionAddress?.touched" />
        </div>
      </div>
    </form>
  </div>

  <ng-template pTemplate="footer" #dialogFooter>
    <button type="button" class="btn btn-secondary" (click)="closeModal()">
      {{ '::Close' | abpLocalization }}
    </button>
    <button class="btn btn-primary" (click)="save()" [disabled]="form?.invalid">
      <i class="fa fa-check me-1"></i> {{ '::Save' | abpLocalization }}
    </button>
  </ng-template>
</p-dialog>
